<?xml version="1.0"?>
 
<PropertyList>
    <!-- autopilot modes of operation:
        auto~leveller ~ recover from any pitch and roll to straight and level flight
            ~ i'm thinking pitch matches alpha for level flight
            ~ roll will be standard "get your wings to 0 bank"
        
        stabilize ~ 2 channels, bank and pitch.
            ~ bank is set to 0 if bank is less than 6, otherwise hold that bank.
            ~ to override, aileron command must be greater than ~0.15 (probably will want to tune that)
            ~ bank hold works up to 80* pitch
            ~ pitch is set to hold whatever is commanded
            ~ can be overridden by elevator input greater than ~0.10 (probably will want to tune that)
            
        low altitude mode ~ if the plane hits a selected altitude, climb and hold another altitude
            ~ altitude climbed to can be anywhere from 20m to 150 m above the danger altitude
            ~ probably the lower the danger alt, the higher the "safe altitude"
            ~ will handle the figuring~out~the~safe~alt using a listener in autopilot.nas
            
        ils ~ follow localizer and glideslope
            ~ to be used for approaches, not full landings


check for Low Altitude Mode
 conditions
        if the low alt switch is on and 
            the danger light is on
            or
            low alt mode has been already triggered

 autopilot.nas has a listener for /autopilot/locks/low~alt~mode to set safe altitude
    
 if the pilot goes below the alt limit, the autopilot kicks in and 
    says nah, climb to this altitude.
    if, during the climb, the alt limit is re~exceeded, then the
    new climb altitude must be computed.

    ergo:
    alt limit is hit, continuously compute new alt until above the alt limit
-->

<!-- modes:
    0 is off
    1 is low-alt
    2 is leveler
    3 is stabilizer
    4 is ils
-->

<!--
    ########################################
    LOW ALTITUDE
    -safe altitude algorithm
    -state machine
    -pid stages 1 & 2
    ########################################
-->

    <filter>
        <name>Calculate Safe Altitude</name>
        <type>gain</type>
        <gain>1</gain>
        <enable>
            <condition>
                <equals>
                    <property>/autopilot/internal/safe-altitude-switch</property>
                    <value>1</value>
                </equals>
            </condition>
        </enable>
        <input>
            <expression>
                <sum>
                    <dif>
                        <property>/instrumentation/altimeter/indicated-altitude-ft</property>
                        <property>/instrumentation/altimeter/radar-altimeter-ft</property>
                    </dif>
                    <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                    <product>
                        <value>3.280839895013123</value>
                        <sum>
                            <value>150</value>
                            <product>
                                <value>-130</value>
                                <div>
                                    <dif>
                                        <product>
                                            <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                                            <value>0.3048</value>
                                        </product>
                                        <value>20</value>
                                    </dif>
                                    <value>580</value>
                                </div>
                            </product>
                        </sum>
                    </product>
                </sum>
            </expression>
        </input>
        <output>/autopilot/internal/safe-alt-calc</output>
    </filter>

    <state-machine>
        <!-- 
            properties used:
            ./internal/safe-alt-calc            calculate the safe altitude to climb to
            ./internal/safe-alt                 actual safe altitude to climb to
            ./internal/safe-altitude-switch     run the safe altitude calculation algorithm
            ./locks/low-alt-mode-armed          the low-alt mode is armed and primed to run
        -->

        <branch>/autopilot/state-machines/low-alt</branch>

        <state>
            <name>off</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>0</value>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>off-no-ap-set</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>armed</name>
        </state>

        <state>
            <name>danger-alt</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>1</value>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-altitude-switch</property>
                <value>0</value>
            </exit>
            <update>
                <command>property-assign</command>
                <property>/autopilot/internal/safe-alt</property>
                <property>/autopilot/internal/safe-alt-calc</property>
            </update>
        </state>

        <state>
            <name>altitude-hold</name>
        </state>

        <transition>
            <name>off-to-armed</name>
            <source>off</source>
            <source>off-no-ap-set</source>
            <target>armed</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <equals>
                    <property>/autopilot/locks/low-alt-mode-armed</property>
                    <value>1</value>
                </equals>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>armed-to-danger-alt</name>
            <sourcee>armed</sourcee>
            <target>danger-alt</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>1</value>
                    </equals>
                    <greater-than>
                        <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                        <property>/position/altitude-agl-ft</property>
                    </greater-than>
                </and>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>danger-alt-to-altitude-hold</name>
            <source>danger-alt</source>
            <target>altitude-hold</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>1</value>
                    </equals>
                    <less-than>
                        <property>/instrumentation/altimeter/altitude-limit-select-ft</property>
                        <property>/position/altitude-agl-ft</property>
                    </less-than>
                </and>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>disable-ap</name>
            <source>danger-alt</source>
            <source>altitude-hold</source>
            <target>off</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/low-alt-mode-armed</property>
                        <value>0</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>0</value>
                    </equals>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                </or>
            </condition>
            <binding>
            </binding>
        </transition>

        <transition>
            <name>disable-ap-2</name>
            <source>danger-alt</source>
            <source>altitude-hold</source>
            <target>off-no-ap-set</target>
            <exclude-target type="bool">true</exclude-target>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>1</value>
                </greater-than>
            </condition>
            <binding>
            </binding>
        </transition>

    </state-machine>


<!-- the actual low-alt pids -->

    <pid-controller>
        <name>Low Altitude Recovery Stage 1</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>1</value>
        </enable>
        <input>
            <property>/instrumentation/altimeter/indicated-altitude-ft</property>
        </input>
        <reference>
            <property>/autopilot/internal/safe-alt</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-vs</property>
        </output>
        <config>
            <Kp>0.21</Kp>
            <Ti>11</Ti>
            <Td>0.001</Td>
            <u_min>-300.0</u_min>
            <u_max>300.0</u_max>
        </config>
    </pid-controller>
    
    <pid-controller>
        <name>Low Altitude Recovery Stage 2</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>1</value>
        </enable>
        <input>
            <property>/instrumentation/gps/indicated-vertical-speed-fps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-vs</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch</property>
        </output>
        <config>
            <Kp>0.05</Kp>
            <Ti>7</Ti>
            <Td>0.0003</Td>
            <u_min>-30</u_min>
            <u_max>45</u_max>
        </config>
    </pid-controller>
    
<!--
    ########################################
    AUTOLEVEL
    -state machine
    -autolevel pitch (v/s based)
    ########################################
-->

    <state-machine>

        <branch>/autopilot/state-machines/autoleveller</branch>

        <state>
            <name>off</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/mode</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>off-no-ap-set</name>
        </state>

        <state>
            <name>active</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/target-pitch</property>
                <value>1</value>
            </enter>
        </state>

        <transition>
            <name>off-to-active</name>
            <source>off</source>
            <source>off-no-ap-set</source>
            <target>active</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>2</value>
                </equals>
            </condition>
        </transition>

        <transition>
            <name>active-to-off</name>
            <source>active</source>
            <target>off</target>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>0</value>
                    </equals>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>0.3</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/rudder-cmd-norm</property>
                        <value>-0.3</value>
                    </less-than>
                </or>
            </condition>
        </transition>

        <transition>
            <name>active-to-off-no-ap-set</name>
            <source>active</source>
            <target>off-no-ap-set</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>2</value>
                </not-equals>
            </condition>
        </transition>

    </state-machine>

    <pid-controller>
        <name>Auto-Leveler Pitch</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>2</value>
        </enable>
        <input>
            <property>/instrumentation/gps/indicated-vertical-speed</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch</property>
        </output>
        <config>
            <Kp>0.0005</Kp>
            <Ti>1.5</Ti>
            <Td>0.0001</Td>
            <u_min>-20</u_min>
            <u_max>45</u_max>
        </config>
    </pid-controller>

<!--
    ########################################
    STABILIZER
    -state machine
	-heading error
    -heading seek pid
    ########################################
-->

    <state-machine>
        <branch>/autopilot/state-machines/stabilizer-roll</branch>

        <state>
            <name>off</name>
        </state>

        <state>
            <name>active-bank</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/target-roll</property>
                <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/stab-mode</property>
                <value>0</value>
            </enter>
        </state>

        <state>
            <name>active-heading</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/target-heading</property>
                <property>/fdm/jsbsim/systems/gyro-compass/heading-deg</property>
            </enter>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/stab-mode</property>
                <value>1</value>
            </enter>
        </state>

        <state>
            <name>suspended</name>
            <enter>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                <value>0</value>
            </exit>
        </state>

        <transition>
            <name>off-to-active-heading</name>
            <source>off</source>
            <target>active-heading</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </equals>
                <less-than>
                    <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                    <value>6</value>
                </less-than>
                <greater-than>
                    <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                    <value>-6</value>
                </greater-than>
            </condition>
        </transition>

        <transition>
            <name>off-to-active-bank</name>
            <source>off</source>
            <target>active-bank</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </equals>
                <or>
                    <less-than>
                        <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                        <value>-6</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                        <value>6</value>
                    </greater-than>
                </or>
            </condition>
        </transition>

        <transition>
            <name>active-to-suspended</name>
            <source>active-bank</source>
            <source>active-heading</source>
            <target>suspended</target>
            <condition>
                <or>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>0.05</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                        <value>-0.05</value>
                    </less-than>
                </or>
            </condition>
        </transition>

        <transition>
            <name>suspended-to-active-bank</name>
            <source>suspended</source>
            <target>active-bank</target>
            <condition>
                <or>
                    <less-than>
                        <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                        <value>-6</value>
                    </less-than>
                    <greater-than>
                        <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                        <value>6</value>
                    </greater-than>
                </or>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                    <value>-0.05</value>
                </greater-than>
                <less-than>
                    <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                    <value>0.05</value>
                </less-than>
            </condition>
        </transition>

        <transition>
            <name>suspended-to-active-heading</name>
            <source>suspended</source>
            <target>active-heading</target>
            <condition>
                <less-than>
                    <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                    <value>6</value>
                </less-than>
                <greater-than>
                    <property>/fdm/jsbsim/instrumentation/input/ap-roll</property>
                    <value>-6</value>
                </greater-than>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                    <value>-0.05</value>
                </greater-than>
                <less-than>
                    <property>/fdm/jsbsim/fcs/aileron-cmd-norm</property>
                    <value>0.05</value>
                </less-than>
            </condition>
        </transition>

        <transition>
            <name>set-off</name>
            <source>active-bank</source>
            <source>active-heading</source>
            <source>suspended</source>
            <target>off</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </not-equals>
            </condition>
        </transition>

    </state-machine>

    <state-machine>
        <branch>/autopilot/state-machines/stabilizer-pitch</branch>

        <state>
            <name>off</name>
        </state>

        <state>
            <name>active</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/target-pitch</property>
                <property>/fdm/jsbsim/instrumentation/input/ap-pitch</property>
            </enter>
        </state>

        <state>
            <name>suspended</name>
            <enter>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                <value>0</value>
            </exit>
        </state>

        <transition>
            <name>off-to-active</name>
            <source>off</source>
            <target>active</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </equals>
            </condition>
        </transition>

        <transition>
            <name>active-to-suspended</name>
            <source>active</source>
            <target>suspended</target>
            <condition>
                <or>
                    <greater-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>0.05</value>
                    </greater-than>
                    <less-than>
                        <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                        <value>-0.05</value>
                    </less-than>
                </or>
            </condition>
        </transition>

        <transition>
            <name>suspended-to-active</name>
            <source>suspended</source>
            <target>active</target>
            <condition>
                <greater-than>
                    <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                    <value>-0.05</value>
                </greater-than>
                <less-than>
                    <property>/fdm/jsbsim/fcs/elevator-cmd-norm</property>
                    <value>0.05</value>
                </less-than>
            </condition>
        </transition>

        <transition>
            <name>set-off</name>
            <source>active</source>
            <source>suspended</source>
            <target>off</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </not-equals>
            </condition>
        </transition>

    </state-machine>
	
    <filter>
        <name>HDG ERROR DEG</name>
        <debug>false</debug>
        <type>gain</type>
        <input>
            <property>/autopilot/internal/target-heading</property>
            <offset>
                <property>/fdm/jsbsim/systems/gyro-compass/heading-deg</property>
                <scale>-1.0</scale>
            </offset>
        </input>
        <output>/autopilot/internal/hdg-error-deg</output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
        <gain>1.0</gain>
    </filter>

    <pi-simple-controller>
        <name>Heading seek stabilizer</name>
        <debug>false</debug>
        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>3</value>
                </equals>
                <equals>
                    <property>/autopilot/locks/stab-mode</property>
                    <value>1</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/autopilot/internal/hdg-error-deg</property>
        </input>
        <reference>
            <value>0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-roll</property>
        </output>
        <config>
            <Kp>-1.0</Kp>
			<Ki>-0.00001</Ki>
            <min>-5</min>
            <max>5</max>
        </config>
    </pi-simple-controller>

<!--
    ########################################
    ILS
    -LOC state machine
    -LOC heading seek pid
    -GS state machine
    -GS feet per second hold
    ########################################
-->

    <state-machine>
        <branch>/autopilot/state-machines/localizer</branch>

        <state>
            <name>off</name>
        </state>

        <state>
            <name>suspended</name>
            <enter>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                <value>0</value>
            </exit>
        </state>

        <state>
            <name>active</name>
        </state>

        <transition>
            <name>set-off</name>
            <source>active</source>
            <source>suspended</source>
            <target>off</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </not-equals>
            </condition>
        </transition>

        <transition>
            <name>set-suspended</name>
            <source>off</source>
            <source>active</source>
            <target>suspended</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </equals>
                <equals>
                    <property>/instrumentation/nav[0]/frequencies/is-localizer-frequency</property>
                    <value>0</value>
                </equals>
            </condition>
        </transition>

        <transition>
            <name>set-active</name>
            <source>off</source>
            <source>suspended</source>
            <target>active</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </equals>
                <equals>
                    <property>/instrumentation/nav[0]/frequencies/is-localizer-frequency</property>
                    <value>1</value>
                </equals>
            </condition>
        </transition>

    </state-machine>

    <pi-simple-controller>
        <name>LOC Heading seek</name>
        <debug>false</debug>
        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/autopilot/internal/nav1-heading-error-deg</property>
        </input>
        <reference>
            <value>0.0</value>
        </reference>
        <output>
            <property>/autopilot/internal/target-roll</property>
        </output>
        <config>
            <Kp>-4.4</Kp>
			<Ki>0.0001</Ki>
            <min>-30</min>
            <max>30</max>
        </config>
    </pi-simple-controller>

    <state-machine>
        <branch>/autopilot/state-machines/glideslope</branch>

        <state>
            <name>off</name>
        </state>

        <state>
            <name>suspended</name>
            <enter>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                <value>1</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                <value>0</value>
            </exit>
        </state>

        <state>
            <name>active</name>
            <enter>
                <command>property-assign</command>
                <property>/instrumentation/nav/gs-rate-of-climb</property>
                <value>0</value>
            </enter>
        </state>

        <transition>
            <name>set-off</name>
            <source>active</source>
            <source>suspended</source>
            <target>off</target>
            <condition>
                <not-equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </not-equals>
            </condition>
        </transition>

        <transition>
            <name>set-suspended</name>
            <source>off</source>
            <source>active</source>
            <target>suspended</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </equals>
                <equals>
                    <property>/instrumentation/nav[0]/has-gs</property>
                    <value>0</value>
                </equals>
            </condition>
        </transition>

        <transition>
            <name>set-active</name>
            <source>off</source>
            <source>suspended</source>
            <target>active</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/mode</property>
                    <value>4</value>
                </equals>
                <equals>
                    <property>/instrumentation/nav[0]/has-gs</property>
                    <value>1</value>
                </equals>
            </condition>
        </transition>

    </state-machine>

    <!-- NAV1 G/S FPM Calc taken from it0uchpod's work on Necolatis' viggen -->

    <filter>
        <name>NAV1 G/S FPM Calc</name>
        <debug>false</debug>
        <type>gain</type>
        <input>
            <property>/instrumentation/nav[0]/gs-rate-of-climb</property>
        </input>
        <output>/autopilot/internal/nav1-rate-of-climb</output>
        <gain>1.0</gain>
        <min>-2500</min>
        <max>0</max>
    </filter>

    <filter>
        <name>GPS Indicated Speed FPS</name>
        <debug>false</debug>
        <type>gain</type>
        <input>
            <property>/instrumentation/gps/indicated-vertical-speed</property>
        </input>
        <output>/instrumentation/gps/indicated-vertical-speed-fps</output>
        <gain>0.0166666666666</gain>
    </filter>

    <pid-controller>
        <name>Glideslope FPS</name>
        <debug>false</debug>
        <enable>
            <property>/autopilot/locks/mode</property>
            <value>4</value>
        </enable>
        <input>
            <property>/instrumentation/gps/indicated-vertical-speed-fps</property>
        </input>
        <reference>
            <property>/autopilot/internal/nav1-rate-of-climb</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch</property>
        </output>
        <config>
            <Kp>0.2</Kp>
            <Ti>1.0</Ti>
            <Td>0.0001</Td>
            <u_min>-10</u_min>
            <u_max>10</u_max>
        </config>
    </pid-controller>

<!--
    ########################################
    MULTI-USE
    -autoleveler and low alt target roll setting
    -target roll to target roll rate
    -target pitch to target pitch rate
    -roll final
    -pitch kp algorithm
    -pitch final
    ########################################
-->

    <!-- set target roll to 0 for autolevel and low-alt climb -->

    <filter>
        <name>Autoleveller and Low altitude roll level setting</name>
        <type>gain</type>
        <gain>1</gain>
        <enable>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>1</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/mode</property>
                        <value>2</value>
                    </equals>
                </or>
            </condition>
        </enable>
        <input>
            <reference>
                <value>0</value>
            </reference>
        </input>
        <output>/autopilot/internal/target-roll</output>
    </filter>
	
	<!-- Roll Degree Calculate -->

    <filter>
        <name>Roll-deg controller</name>
        <debug>false</debug>
		<type>gain</type>
		<gain>-1</gain>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <equals>
                    <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                    <value>0</value>
                </equals>
            </condition>
        </enable>
        <input>
            <prop>/fdm/jsbsim/instrumentation/input/ap-roll</prop>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll</property>
        </reference>
        <output>
            <prop>/autopilot/internal/target-roll-rate-degps</prop>
        </output>
		<min>-15</min>
		<max>15</max>
    </filter>
	
	<!-- Pitch Degree Calculate -->
	
    <filter>
        <name>Pitch-deg controller</name>
        <debug>false</debug>
		<type>gain</type>
		<gain>-1.5</gain>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <equals>
                    <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                    <value>0</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/fdm/jsbsim/instrumentation/input/ap-pitch</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-pitch</property>
        </reference>
        <output>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </output>
		<min>-10</min>
		<max>10</max>
    </filter>

    <!-- Roll/Pitch Final Controllers -->
	
    <pid-controller>
        <name>Roll Final</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <less-than>
                    <property>/autopilot/locks/mode</property>
                    <value>5</value>
                </less-than>
                <equals>
                    <property>/fdm/jsbsim/fcs/aileron-manual-override</property>
                    <value>0</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/orientation/roll-rate-degps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-roll-rate-degps</property>
        </reference>
        <output>
            <property>/fdm/jsbsim/fcs/aileron-ap-cmd-norm</property>
        </output>
        <config>
            <Kp><property>autopilot/settings/roll-final/kp</property></Kp>
            <Ti><property>autopilot/settings/roll-final/ti</property></Ti>
            <Td><property>autopilot/settings/roll-final/td</property></Td>
            <u_min><property>autopilot/settings/roll-final/u_min</property></u_min>
            <u_max><property>autopilot/settings/roll-final/u_max</property></u_max>
        </config>
    </pid-controller>

    <filter>
        <name>PITCH KP (P Gain)</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <table>
                    <property>/velocities/mach</property>
                    <entry><ind>0.35</ind><dep>-0.22</dep></entry>
                    <entry><ind>0.95</ind><dep>-0.15</dep></entry>
                    <entry><ind>1.50</ind><dep>-0.11</dep></entry>
                </table>
            </expression>
        </input>
        <output>/autopilot/internal/pitch-rate-kp</output>
    </filter>

    <pid-controller>
        <name>Pitch Final</name>
        <debug>false</debug>
        <enable>
            <condition>
                <greater-than>
                    <property>/autopilot/locks/mode</property>
                    <value>0</value>
                </greater-than>
                <less-than>
                    <property>/autopilot/locks/mode</property>
                    <value>5</value>
                </less-than>
                <equals>
                    <property>/fdm/jsbsim/fcs/elevator-manual-override</property>
                    <value>0</value>
                </equals>
            </condition>
        </enable>
        <input>
            <property>/orientation/pitch-rate-degps</property>
        </input>
        <reference>
            <property>/autopilot/internal/target-pitch-rate-degps</property>
        </reference>
        <output>
            <property>/fdm/jsbsim/fcs/elevator-ap-cmd-norm</property>
        </output>
        <config>
            <Kp><property>/autopilot/internal/pitch-rate-kp</property></Kp>
            <Ti>0.35</Ti>
            <Td>0.01</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>

</PropertyList>